name: Build macOS Core ML App

on:
  push:
    paths:
      - apple_local_translator_coreml/**
      - .github/workflows/macos-coreml-app-build.yml
  pull_request:
    paths:
      - apple_local_translator_coreml/**
      - .github/workflows/macos-coreml-app-build.yml
  workflow_dispatch:

jobs:
  build-macos-coreml-app:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        working-directory: apple_local_translator_coreml
        run: |
          set -euxo pipefail
          xcodegen generate

      - name: Build macOS Core ML app
        working-directory: apple_local_translator_coreml
        run: |
          set -euxo pipefail
          xcodebuild \
            -project LocalTranslatorCoreMLMac.xcodeproj \
            -scheme LocalTranslatorCoreMLMac \
            -configuration Release \
            -destination "platform=macOS" \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            build

      - name: Package app artifact
        working-directory: apple_local_translator_coreml
        run: |
          set -euxo pipefail
          cd build/DerivedData/Build/Products/Release
          zip -r LocalTranslatorCoreMLMac.app.zip LocalTranslatorCoreMLMac.app

      - name: Upload app artifact
        uses: actions/upload-artifact@v4
        with:
          name: LocalTranslatorCoreMLMac-app
          path: apple_local_translator_coreml/build/DerivedData/Build/Products/Release/LocalTranslatorCoreMLMac.app.zip
          if-no-files-found: error
          retention-days: 7
